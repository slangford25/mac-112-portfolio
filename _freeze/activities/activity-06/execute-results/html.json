{
  "hash": "d0a71f68d08619a57ea9e078ff078a8b",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"activity-06\"\nnumber-sections: true\nexecute: \n  warning: false\nfig-env: 'figure'\nfig-pos: 'h'\nfig-align: center\ncode-fold: false\n---\n\n\n\n::: {.callout-caution title=\"Learning Goals\"}\n\n-   Plot data points on top of a map (`ggplot()`).\n-   Create choropleth maps (`geom_map()`).\n-   Understand the basics of creating a map using `leaflet`, including adding points and choropleths to a base map.\n\n:::\n\n\n::: {.callout-note title=\"Additional Resources\"}\n\nFor more information about the topics covered in this chapter, refer to the resources below:\n \n-   [Creating maps with leaflet (YouTube)](https://www.youtube.com/embed/w5U62wUki3E) by Lisa Lendway\n-   [More leaflet (YouTube)](https://www.youtube.com/embed/U07OQ3V-W2k) by Lisa Lendway\n-   [Spatial data visualization (Chp 17, intro and 17.1, html)](https://mdsr-book.github.io/mdsr2e/ch-spatial.html) by Baumer et al\n-   [Detailed leaflet documenation (html)](https://rstudio.github.io/leaflet/)\n-   [leaflet cheat sheet (pdf)](https://ugoproto.github.io/ugo_r_doc/pdf/leaflet-cheat-sheet.pdf)\n-   [Provider map previews (html)](http://leaflet-extras.github.io/leaflet-providers/preview/)\n-   [Tutorial (html)](https://learn.r-journalism.com/en/mapping/census_maps/census-maps/) by Andrew Ba Tran, investigative data reporter at Washington Post\n-   For more advanced work with spatial mapping, GIS in R, etc. see the [sf package (html)](https://r-spatial.github.io/sf/).\n\n:::\n\n::: {.callout-important title=\"Instructions\"}\n\n**General**\n\n-   Be kind to yourself.\n-   Collaborate with and be kind to others. You are expected to work together as a group.\n-   Ask questions. Remember that we won't discuss these exercises as a class.\n\n\n**Activity Specific**\n\n\nHelp each other with the following:\n\n-   Create a new Quarto document in the activities folder of your portfolio project and do not forgot to include it in `_quarto.yml` file.  Then click the `</> Code` link at the top right corner of this page and copy the code into the created Quarto document.  This is where you'll take notes.  Remember that the portfolio is yours, so take notes in whatever way is best for you.\n-   **Don't start the Exercises section before we get there as a class.** First, engage in class discussion and eventually collaborate with your group on the exercises!\n\n:::\n\n::: {.callout-important title=\"Instructions\"}\n\nRun the following commands in the Console to install the packages used in this activity into your machine if they are not already installed.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninstall.packages(c(\"sf\", \"maps\", \"RColorBrewer\", \"gplots\", \"socviz\", \"leaflet\", \"devtools\"))\ndevtools::install_github(\"ropensci/rnaturalearthhires\")\n```\n:::\n\n\n\n:::\n\n\n\n## Review\n\nIn the previous activity, we explored a Simpson's Paradox--it seemed that:\n\n-   States with higher spending...\n-   tend to have lower average SAT scores.\n\nBUT this was explained by a *confounding* or *omitted* or *lurking* variable: the % of students in a state that take the SAT:\n\n-   States with higher spending...\n-   tend to have a higher % of students of students that take the SAT...\n-   which then \"leads to\" lower average SAT scores.\n\nThus, *when controlling for the % of students that take the SAT*, more spending is correlated with higher scores.\n\nLet's explore a Simpson's paradox related to Mac!\n\nBack in the 2000s, Macalester invested in insulating a few campus-owned houses, with the hopes of leading to energy savings. <!-- 180/182 Vernon Ave, 1662 Princeton Ave, and 1668 Princeton Ave --> Former Mac prof Danny Kaplan accessed monthly data on energy use and other info for these addresses, before and after renovations:\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stdout}\n\n```\n  month year  price therms hdd address renovated       date\n1     6 2005  35.21     21   0       a        no 2005-06-01\n2     7 2005  37.37     21   0       a        no 2005-07-01\n3     8 2005  36.93     21   3       a        no 2005-08-01\n4     9 2005  62.36     39  61       a        no 2005-09-01\n5    10 2005 184.15    120 416       a        no 2005-10-01\n6    11 2005 433.35    286 845       a        no 2005-11-01\n```\n\n\n:::\n:::\n\n\nIncluded are the following variables:\n\n| variable  | meaning                                                                                                      |\n|:---------------|:-------------------------------------------------------|\n| therms    | a measure of energy use (the more energy used, the larger the therms)                                        |\n| address   | a or b                                                                                                       |\n| renovated | whether the location had been renovated, yes or no                                                           |\n| month     | from 1 to 12                                                                                                 |\n| hdd       | monthly heating degree days. a proxy measure of outside temperatures (the higher the hdd, the COLDER it was) |\n\n::: {.callout-important title=\"Instructions\"}\n\n-  Construct a plot that addresses each research question\n-  Include a 1-sentence summary of the plot.\n\n:::\n\n\n\n### Example 1 {-}\n\nWhat was range in, and typical, energy used each month, as measured by `therms`? How does this differ by address?\n\n\n::: {.cell}\n\n:::\n\n\n### Example 2 {-}\n\nHow did energy use (`therms`) change over time (`date`) at the two addresses?\n\n\n::: {.cell}\n\n:::\n\n\n### Example 3 {-}\n\nHow did the typical energy use (`therms`) at the two addresses change before and after they were `renovated`?\n\n\n::: {.cell}\n\n:::\n\n\n### Example 4 {-}\n\nThat seems unfortunate that energy usage went *up* after renovations. But also fishy.\n\nTake 5 minutes in your groups to try and explain what's going on here. Think: What *confounding*, *lurking*, or *omitted* variable related to energy usage are we ignoring here? Try to make some plots to prove your point.\n\n\n::: {.cell}\n\n:::\n\n\n### Example 5 {-}\n\nLet's summarize the punchlines by filling in the ???. It seemed that:\n\n-   After renovation...\n-   energy use increased.\n\nBUT this was explained by a *confounding* or *omitted* or *lurking* variable: ???\n\n-   After renovation...\n-   ???...\n-   which then leads to higher energy use.\n\nThus, *when controlling for* ???, renovations led to *decreased* energy use.\n\n\n## New stuff\n\n**Types of spatial viz:**\n\n-   **Point Maps**: plotting locations of *individual observations*\\\n    example: [bigfoot sightings](https://experience.arcgis.com/experience/9cc90686aa164853a1355f310f66ede0)\n\n-   **Contour Maps**: plotting the *density* or distribution of observations (not the individual observations themselves)\n\n-   **Choropleth Maps**: plotting outcomes in different *regions*\n    -   [NYT article on effects of redlining](https://www.nytimes.com/interactive/2020/08/24/climate/racism-redlining-cities-global-warming.html?fbclid=IwAR1iX20gZcHt-HERYeJs0t2fjSXRJh2aBYYSfSkpc50dBvfByBCWezTSXbw)\n    -   [Minnesota Reformer article on how Mpls / St Paul voted on 2021 ballot measures related to mayoral, policing, and rent policies](https://minnesotareformer.com/2021/11/04/maps-how-minneapolis-voted-on-key-ballot-questions/)\n\nThese spatial maps can be **static** or **dynamic/interactive**.\n\n\n\n## Exercises\n\n### Preview\n\nYou'll explore some R spatial viz tools below. In general, there are two important pieces to every map:\n\n**Piece 1: A dataset**\n\nThis dataset must include either:\n\n-   location coordinates for your points of interest (for point maps); or\n-   variable outcomes for your regions of interest (for choropleth maps)\n\n\\\n\n**Piece 2: A background map**\n\nWe need latitude and longitude coordinates to specify the boundaries for your regions of interest (eg: countries, states). This is where it gets really sticky!\n\n-   County-level, state-level, country-level, continent-level info live in multiple places.\n\n-   Where we grab this info *can* depend upon whether we want to make a point map or a choropleth map. (The background maps can be used somewhat interchangeably, but it requires extra code :/)\n\n-   Where we grab this info can also depend upon the structure of our data and how much data wrangling / cleaning we're up for. For choropleth maps, the labels of regions in our data must match those in the background map. For example, if our data labels states with their abbreviations (eg: MN) and the background map refers to them as full names in lower case (eg: minnesota), we have to wrangle our data so that it matches the background map.\n\nIn short, the code for spatial viz gets very specialized. The goal of these exercises is to:\n\n-   play around and experience the wide variety of spatial viz tools out there\n-   understand the difference between point maps and choropleth maps\n-   have fun\n\nYou can skip around as you wish and it's totally fine if you don't finish everything. Just come back at some point to play around.\n\n\n### Part 1: Interactive points on a map with `leaflet`\n\n[Leaflet](https://leafletjs.com/) is an open-source JavaScript library for creating maps. We can use it inside R through the `leaflet` package.\n\nThis uses a different plotting framework than `ggplot2`, but still has a `tidyverse` feel (which will become more clear as we learn other tidyverse tools!).\n\nThe general steps are as follows:\n\n1.  Create a *map widget* by calling `leaflet()` and telling it the data to use.\n2.  Add a *base map* using `addTiles()` (the default) or `addProviderTiles()`.\n3.  Add *layers* to the map using layer functions (e.g. `addMarkers()`, `addPolygons()`).\n4.  Print the map widget to *display* it.\n\n\n#### Exercise 1: A leaflet with markers / points {-}\n\nEarlier this semester, I asked for the latitude and longitude of one of your favorite places. I rounded these to the nearest whole number, so that they're near to but not exactly at those places. Let's load the data and map it!\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfave_places <- read.csv(\"https://ajohns24.github.io/data/112/our_fave_places.csv\")\n\n# Check it out\nhead(fave_places)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  latitude longitude\n1       46      -123\n2       33        52\n3       48       -90\n4       36      -112\n5       59        25\n6       39      -106\n```\n\n\n:::\n:::\n\n\n##### Part a {-}\n\nYou can use a \"two-finger scroll\" to zoom in and out.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load the leaflet package\nlibrary(leaflet)\n\n# Just a plotting frame\n# leaflet(data = fave_places)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Now what do we have?\nleaflet(data = fave_places) %>% \n  addTiles()\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"leaflet html-widget html-fill-item\" id=\"htmlwidget-629b8d814a1cfece18f8\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-629b8d814a1cfece18f8\">{\"x\":{\"options\":{\"crs\":{\"crsClass\":\"L.CRS.EPSG3857\",\"code\":null,\"proj4def\":null,\"projectedBounds\":null,\"options\":{}}},\"calls\":[{\"method\":\"addTiles\",\"args\":[\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\",null,null,{\"minZoom\":0,\"maxZoom\":18,\"tileSize\":256,\"subdomains\":\"abc\",\"errorTileUrl\":\"\",\"tms\":false,\"noWrap\":false,\"zoomOffset\":0,\"zoomReverse\":false,\"opacity\":1,\"zIndex\":1,\"detectRetina\":false,\"attribution\":\"&copy; <a href=\\\"https://openstreetmap.org/copyright/\\\">OpenStreetMap<\\/a>,  <a href=\\\"https://opendatacommons.org/licenses/odbl/\\\">ODbL<\\/a>\"}]}]},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Now what do we have?\n# longitude and latitude refer to the variables in our data\nleaflet(data = fave_places) %>% \n  addTiles() %>% \n  addMarkers(lng = ~longitude, lat = ~latitude)\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"leaflet html-widget html-fill-item\" id=\"htmlwidget-f24089d7e9d4bb974c92\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-f24089d7e9d4bb974c92\">{\"x\":{\"options\":{\"crs\":{\"crsClass\":\"L.CRS.EPSG3857\",\"code\":null,\"proj4def\":null,\"projectedBounds\":null,\"options\":{}}},\"calls\":[{\"method\":\"addTiles\",\"args\":[\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\",null,null,{\"minZoom\":0,\"maxZoom\":18,\"tileSize\":256,\"subdomains\":\"abc\",\"errorTileUrl\":\"\",\"tms\":false,\"noWrap\":false,\"zoomOffset\":0,\"zoomReverse\":false,\"opacity\":1,\"zIndex\":1,\"detectRetina\":false,\"attribution\":\"&copy; <a href=\\\"https://openstreetmap.org/copyright/\\\">OpenStreetMap<\\/a>,  <a href=\\\"https://opendatacommons.org/licenses/odbl/\\\">ODbL<\\/a>\"}]},{\"method\":\"addMarkers\",\"args\":[[46,33,48,36,59,39,18,40,44,29,38,-24,52,45,35,37,40,42,-34,45,40,3,53,40,21,-1,31],[-123,52,-90,-112,25,-106,-66,-107,-68,-81,-122,-66,5,-87,-81,-4,-4,-72,-53,-123,-74,10,-6,-106,106,-90,7],null,null,null,{\"interactive\":true,\"draggable\":false,\"keyboard\":true,\"title\":\"\",\"alt\":\"\",\"zIndexOffset\":0,\"opacity\":1,\"riseOnHover\":false,\"riseOffset\":250},null,null,null,null,null,{\"interactive\":false,\"permanent\":false,\"direction\":\"auto\",\"opacity\":1,\"offset\":[0,0],\"textsize\":\"10px\",\"textOnly\":false,\"className\":\"\",\"sticky\":true},null]}],\"limits\":{\"lat\":[-34,59],\"lng\":[-123,106]}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Since we named them \"longitude\" and \"latitude\", the function\n# automatically recognizes these variables. No need to write them!\nleaflet(data = fave_places) %>% \n  addTiles() %>% \n  addMarkers()\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"leaflet html-widget html-fill-item\" id=\"htmlwidget-7700fd19c215394f0d1f\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-7700fd19c215394f0d1f\">{\"x\":{\"options\":{\"crs\":{\"crsClass\":\"L.CRS.EPSG3857\",\"code\":null,\"proj4def\":null,\"projectedBounds\":null,\"options\":{}}},\"calls\":[{\"method\":\"addTiles\",\"args\":[\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\",null,null,{\"minZoom\":0,\"maxZoom\":18,\"tileSize\":256,\"subdomains\":\"abc\",\"errorTileUrl\":\"\",\"tms\":false,\"noWrap\":false,\"zoomOffset\":0,\"zoomReverse\":false,\"opacity\":1,\"zIndex\":1,\"detectRetina\":false,\"attribution\":\"&copy; <a href=\\\"https://openstreetmap.org/copyright/\\\">OpenStreetMap<\\/a>,  <a href=\\\"https://opendatacommons.org/licenses/odbl/\\\">ODbL<\\/a>\"}]},{\"method\":\"addMarkers\",\"args\":[[46,33,48,36,59,39,18,40,44,29,38,-24,52,45,35,37,40,42,-34,45,40,3,53,40,21,-1,31],[-123,52,-90,-112,25,-106,-66,-107,-68,-81,-122,-66,5,-87,-81,-4,-4,-72,-53,-123,-74,10,-6,-106,106,-90,7],null,null,null,{\"interactive\":true,\"draggable\":false,\"keyboard\":true,\"title\":\"\",\"alt\":\"\",\"zIndexOffset\":0,\"opacity\":1,\"riseOnHover\":false,\"riseOffset\":250},null,null,null,null,null,{\"interactive\":false,\"permanent\":false,\"direction\":\"auto\",\"opacity\":1,\"offset\":[0,0],\"textsize\":\"10px\",\"textOnly\":false,\"className\":\"\",\"sticky\":true},null]}],\"limits\":{\"lat\":[-34,59],\"lng\":[-123,106]}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n##### Part b {-}\n\n**PLAY AROUND!** This map is interactive. Zoom in on one location. Keep zooming -- what level of detail can you get into? How does that detail depend upon where you try to zoom in (thus what are the limitations of this tool)?\n\n\n#### Exercise 2: Details {-}\n\nWe can change all sorts of details in leaflet maps.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load package needed to change color\nlibrary(gplots)\n\n# We can add colored circles instead of markers at each location\nleaflet(data = fave_places) %>% \n  addTiles() %>% \n  addCircles(color = col2hex(\"red\"))\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"leaflet html-widget html-fill-item\" id=\"htmlwidget-b096bcdb3d28395437d6\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-b096bcdb3d28395437d6\">{\"x\":{\"options\":{\"crs\":{\"crsClass\":\"L.CRS.EPSG3857\",\"code\":null,\"proj4def\":null,\"projectedBounds\":null,\"options\":{}}},\"calls\":[{\"method\":\"addTiles\",\"args\":[\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\",null,null,{\"minZoom\":0,\"maxZoom\":18,\"tileSize\":256,\"subdomains\":\"abc\",\"errorTileUrl\":\"\",\"tms\":false,\"noWrap\":false,\"zoomOffset\":0,\"zoomReverse\":false,\"opacity\":1,\"zIndex\":1,\"detectRetina\":false,\"attribution\":\"&copy; <a href=\\\"https://openstreetmap.org/copyright/\\\">OpenStreetMap<\\/a>,  <a href=\\\"https://opendatacommons.org/licenses/odbl/\\\">ODbL<\\/a>\"}]},{\"method\":\"addCircles\",\"args\":[[46,33,48,36,59,39,18,40,44,29,38,-24,52,45,35,37,40,42,-34,45,40,3,53,40,21,-1,31],[-123,52,-90,-112,25,-106,-66,-107,-68,-81,-122,-66,5,-87,-81,-4,-4,-72,-53,-123,-74,10,-6,-106,106,-90,7],10,null,null,{\"interactive\":true,\"className\":\"\",\"stroke\":true,\"color\":\"#FF0000\",\"weight\":5,\"opacity\":0.5,\"fill\":true,\"fillColor\":\"#FF0000\",\"fillOpacity\":0.2},null,null,null,{\"interactive\":false,\"permanent\":false,\"direction\":\"auto\",\"opacity\":1,\"offset\":[0,0],\"textsize\":\"10px\",\"textOnly\":false,\"className\":\"\",\"sticky\":true},null,null]}],\"limits\":{\"lat\":[-34,59],\"lng\":[-123,106]}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# We can change the background\n# Mark locations with yellow dots\n# And connect the dots, in their order in the dataset, with green lines\n# (These green lines don't mean anything here, but would if this were somebody's travel path!)\nleaflet(data = fave_places) %>%\n  addProviderTiles(\"USGS\") %>%\n  addCircles(weight = 10, opacity = 1, color = col2hex(\"yellow\")) %>%\n  addPolylines(\n    lng = ~longitude,\n    lat = ~latitude,\n    color = col2hex(\"green\")\n  )\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"leaflet html-widget html-fill-item\" id=\"htmlwidget-b450abd9ed23f11437f3\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-b450abd9ed23f11437f3\">{\"x\":{\"options\":{\"crs\":{\"crsClass\":\"L.CRS.EPSG3857\",\"code\":null,\"proj4def\":null,\"projectedBounds\":null,\"options\":{}}},\"calls\":[{\"method\":\"addProviderTiles\",\"args\":[\"USGS\",null,null,{\"errorTileUrl\":\"\",\"noWrap\":false,\"detectRetina\":false}]},{\"method\":\"addCircles\",\"args\":[[46,33,48,36,59,39,18,40,44,29,38,-24,52,45,35,37,40,42,-34,45,40,3,53,40,21,-1,31],[-123,52,-90,-112,25,-106,-66,-107,-68,-81,-122,-66,5,-87,-81,-4,-4,-72,-53,-123,-74,10,-6,-106,106,-90,7],10,null,null,{\"interactive\":true,\"className\":\"\",\"stroke\":true,\"color\":\"#FFFF00\",\"weight\":10,\"opacity\":1,\"fill\":true,\"fillColor\":\"#FFFF00\",\"fillOpacity\":0.2},null,null,null,{\"interactive\":false,\"permanent\":false,\"direction\":\"auto\",\"opacity\":1,\"offset\":[0,0],\"textsize\":\"10px\",\"textOnly\":false,\"className\":\"\",\"sticky\":true},null,null]},{\"method\":\"addPolylines\",\"args\":[[[[{\"lng\":[-123,52,-90,-112,25,-106,-66,-107,-68,-81,-122,-66,5,-87,-81,-4,-4,-72,-53,-123,-74,10,-6,-106,106,-90,7],\"lat\":[46,33,48,36,59,39,18,40,44,29,38,-24,52,45,35,37,40,42,-34,45,40,3,53,40,21,-1,31]}]]],null,null,{\"interactive\":true,\"className\":\"\",\"stroke\":true,\"color\":\"#00FF00\",\"weight\":5,\"opacity\":0.5,\"fill\":false,\"fillColor\":\"#00FF00\",\"fillOpacity\":0.2,\"smoothFactor\":1,\"noClip\":false},null,null,null,{\"interactive\":false,\"permanent\":false,\"direction\":\"auto\",\"opacity\":1,\"offset\":[0,0],\"textsize\":\"10px\",\"textOnly\":false,\"className\":\"\",\"sticky\":true},null]}],\"limits\":{\"lat\":[-34,59],\"lng\":[-123,106]}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\nIn general:\n\n-   `addProviderTiles()` changes the base map.\\\n    To explore all available provider base maps, type `providers` in the console. (Though some don't work :/)\n\n-   Use `addMarkers()` or `addCircles()` to mark locations. Type `?addControl` into the console to pull up a help file which summarizes the aesthetics of these markers and how you can change them. For example:\n\n    -   `weight` = how thick to make the lines, points, pixels\n    -   `opacity` = transparency (like `alpha` in `ggplot2`)\n    -   colors need to be in \"hex\" form. We used the `col2hex()` function from the `gplots` library to do that\n\n\n#### Exercise 3: Your turn {-}\n\nThe `starbucks` data, compiled by Danny Kaplan, contains information about every Starbucks in the world at the time the data were collected, including `Latitude` and `Longitude`:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Import starbucks location data\nstarbucks <- read.csv(\"https://mac-stat.github.io/data/starbucks.csv\")\n```\n:::\n\n\nLet's focus on only those in Minnesota for now:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Don't worry about the syntax\nstarbucks_mn <- starbucks %>%   \n  filter(Country == \"US\", State.Province == \"MN\")\n```\n:::\n\n\nCreate a leaflet map of the Starbucks locations in Minnesota. Keep it simple -- go back to Exercise 1 for an example.\n\n\n### Part 2: Static points on a map\n\nLeaflet is very powerful and fun. But:\n\n-   It's not great when we have lots of points to map -- it takes lots of time.\n-   It makes good interactive maps, but we often need a static map (eg: we can print interactive maps!).\n\nLet's explore how to make point maps with `ggplot()`, not `leaflet()`.\n\n\n#### Exercise 3: A simple scatterplot {-}\n\nLet's start with the `ggplot()` tools we already know. Construct a scatterplot of all `starbucks` locations, not just those in Minnesota, with:\n\n-   Latitude and Longitude coordinates (which goes on the y-axis?!)\n-   Make the points transparent (alpha = 0.2) and smaller (size = 0.2)\n\nIt's pretty cool that the plots we already know can provide some spatial context. But what *don't* you like about this plot?\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(starbucks, aes(x=Longitude, y = Latitude)) +\n  geom_point()\n```\n\n::: {.cell-output-display}\n![](activity-06_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n\n\n#### Exercise 4: Adding a country-level background {-}\n\nLet's add a background map of *country-level* boundaries.\n\n#### Part a {-}\n\nFirst, we can grab country-level boundaries from the `rnaturalearth` package.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load the package\nlibrary(rnaturalearth)\n\n# Get info about country boundaries across the world\n# in a \"sf\" or simple feature format\nworld_boundaries <- ne_countries(returnclass = \"sf\")\n```\n:::\n\n\nIn your **console**, type `world_boundaries` to check out what's stored there. Don't print it our in your Rmd -- printing it would be really messy there (even just the `head()`).\n\n##### Part b {-}\n\nRun the chunks below to build up a new map.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# What does this code produce?\n# What geom are we using for the point map?\nggplot(world_boundaries) + \n  geom_sf()\n```\n\n::: {.cell-output-display}\n![](activity-06_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load package needed to change map theme\nlibrary(mosaic)\n\n# Add a point for each Starbucks\n# NOTE: The Starbucks info is in our starbucks data, not world_boundaries\n# How does this change how we use geom_point?!\nggplot(world_boundaries) + \n  geom_sf() + \n  geom_point(\n    data = starbucks,\n    aes(x = Longitude, y = Latitude),\n    alpha = 0.3, size = 0.2, color = \"darkgreen\"\n  ) +\n  theme_map()\n```\n\n::: {.cell-output-display}\n![](activity-06_files/figure-html/unnamed-chunk-19-1.png){width=672}\n:::\n:::\n\n\n##### Part c {-}\n\nSummarize what you learned about Starbucks from this map.\nThere are a lot of starbucks in north america, europe, eastern china, and japan\n\n\n#### Exercise 5: Zooming in on some countries {-}\n\nInstead of `world_boundaries <- ne_countries(returnclass = 'sf')` we could zoom in on...\n\n-   the continent of Africa: `ne_countries(continent = 'Africa', returnclass = 'sf')`\n-   a set of countries: `ne_countries(country = c('france', 'united kingdom', 'germany'), returnclass = 'sf')`\n-   boundaries within a country: `ne_states(country = 'united states of america', returnclass = 'sf')`\n\nOur goal here will be to map the Starbucks locations in Canada, Mexico, and the US.\n\n##### Part a {-}\n\nTo make this map, we again need two pieces of information.\n\n1.  Data on Starbucks for *only* Canada, Mexico, and the US, labeled as \"CA\", \"MX\", \"US\" in the `starbucks` data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# We'll learn this syntax soon! Don't worry about it now.\nstarbucks_cma <- starbucks %>% \n  filter(Country %in% c('CA', 'MX', 'US'))\n```\n:::\n\n\n2.  A background map of state- and national-level boundaries in Canada, Mexico, and the US. This requires `ne_states()` in the `rnaturalearth` package where the countries are labeled 'canada', 'mexico', 'united states of america'.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# cma_boundaries <- ne_states(\n#   country = c(\"canada\", \"mexico\", \"united states of america\"),\n#   returnclass = \"sf\")\n```\n:::\n\n\n##### Part b {-}\n\nMake the map!\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Just the boundaries\n#ggplot(cma_boundaries) + \n # geom_sf()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Add the points\n# And zoom in\n#ggplot(cma_boundaries) + \n#  geom_sf() + \n#  geom_point(\n#    data = starbucks_cma,\n #   aes(x = Longitude, y = Latitude),\n  #  alpha = 0.3,\n   # size = 0.2,\n#    color = \"darkgreen\"\n # ) +\n  #coord_sf(xlim = c(-179.14, -50)) +\n  #theme_map()\n```\n:::\n\n\n\n#### Exercise 6: A state and county-level map {-}\n\nLet's get an even *higher* resolution map of Starbucks locations within the states of Minnesota, Wisconsin, North Dakota, and South Dakota, with a background map at the county-level.\n\n#### Part a {-}\n\nTo make this map, we again need two pieces of information.\n\n1.  Data on Starbucks for *only* the states of interest.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstarbucks_midwest <- starbucks %>% \n  filter(State.Province %in% c(\"MN\", \"ND\", \"SD\", \"WI\"))\n```\n:::\n\n\n2.  A background map of state- and county-level boundaries in these states. This requires `st_as_sf()` in the `sf` package, and `map()` in the `maps` package, where the countries are labeled 'minnesota', 'north dakota', etc.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load packages\nlibrary(sf)\nlibrary(maps)\n\n# Get the boundaries\nmidwest_boundaries <- st_as_sf(\n  maps::map(\"county\",\n            region = c(\"minnesota\", \"wisconsin\", \"north dakota\", \"south dakota\"), \n            fill = TRUE, plot = FALSE))\n\n# Check it out\nhead(midwest_boundaries)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 6 features and 1 field\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: -96.81268 ymin: 45.05167 xmax: -93.01397 ymax: 48.53526\nGeodetic CRS:  +proj=longlat +ellps=clrk66 +no_defs +type=crs\n                                     ID                           geom\nminnesota,aitkin       minnesota,aitkin MULTIPOLYGON (((-93.03689 4...\nminnesota,anoka         minnesota,anoka MULTIPOLYGON (((-93.51817 4...\nminnesota,becker       minnesota,becker MULTIPOLYGON (((-95.14537 4...\nminnesota,beltrami   minnesota,beltrami MULTIPOLYGON (((-95.58655 4...\nminnesota,benton       minnesota,benton MULTIPOLYGON (((-93.77027 4...\nminnesota,big stone minnesota,big stone MULTIPOLYGON (((-96.10794 4...\n```\n\n\n:::\n:::\n\n\n##### Part b {-}\n\nAdjust the code below to make the plot! Remove the `#` to run it.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ggplot(___) + \n#   geom___() + \n#   geom___(\n#     data = ___,\n#     aes(x = ___, y = ___),\n#     alpha = 0.7,\n#     size = 0.2, \n#     color = 'darkgreen'\n#   ) + \n#   theme_map()\n```\n:::\n\n\n\n#### Exercise 7: Contour maps {-}\n\nEspecially when there are lots of point locations, and those locations start overlapping on a map, it can be tough to visualize areas of higher *density*. Consider the Starbucks locations in Canada, Mexico, and the US that we mapped earlier:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Point map (we made this earlier)\n#ggplot(cma_boundaries) + \n#  geom_sf() + \n # geom_point(\n  #  data = starbucks_cma,\n   # aes(x = Longitude, y = Latitude),\n    #alpha = 0.3,\n  #  size = 0.2,\n   # color = \"darkgreen\"\n # ) +\n#  coord_sf(xlim = c(-179.14, -50), ylim = c(14.54, 83.11)) +\n#  theme_map()\n```\n:::\n\n\nNow check out the contour map.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# What changed in the plot?\n# What changed in our code?!\n#ggplot(cma_boundaries) + \n # geom_sf() + \n # geom_density_2d(\n#    data = starbucks_cma,\n  #  aes(x = Longitude, y = Latitude),\n  #  size = 0.2,\n   # color = \"darkgreen\"\n # ) +\n # coord_sf(xlim = c(-179.14, -50), ylim = c(14.54, 83.11)) +\n#  theme_map()\n```\n:::\n\n\n\n### Part 3: Choropleth maps\n\nSpatial data isn't always in the form of point locations! For example, recall the state and county-level data on presidential elections.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nelections_by_state <-  read.csv(\"https://mac-stat.github.io/data/election_2020_by_state.csv\")\nelections_by_counties <- read.csv(\"https://mac-stat.github.io/data/election_2020_county.csv\")\n```\n:::\n\n\nIn these datasets, we're interested in the overall election outcome by region (state or county), not the specific geographic location of some observation. Let's wrangle our data first. We'll focus on just a few variables of interest, and create a new variable (`repub_20_categories`) that *discretizes* the `repub_pct_20` variable into increments of 5 percentage points (for states) or 10 percentage points (for counties):\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Don't worry about the code!\n\nelections_by_state <- elections_by_state %>% \n  filter(state_abbr != \"DC\") %>% \n  select(state_name, state_abbr, repub_pct_20) %>% \n  mutate(repub_20_categories = \n           cut(repub_pct_20, \n               breaks = seq(30, 70, by = 5), \n               labels = c(\"30-34\", \"35-39\", \"40-44\", \"45-49\",\n                          \"50-54\", \"55-59\", \"60-64\", \"65-70\"), \n               include.lowest = TRUE))\n\nelections_by_counties <- elections_by_counties %>% \n  select(state_name, state_abbr, county_name, county_fips,\n          repub_pct_20, median_age, median_rent) %>% \n  mutate(repub_20_categories = \n           cut(repub_pct_20, \n               breaks = seq(0, 100, by = 10),\n               labels = c(\"0-9\", \"10-19\", \"20-29\", \"30-39\", \"40-49\",\n                          \"50-59\", \"60-69\", \"70-79\", \"80-89\", \"90-100\"),\n               include.lowest = TRUE))\n```\n:::\n\n\n\n#### Exercise 8: State-level choropleth maps {-}\n\nLet's map the 2020 Republican support in each *state*, `repub_pct_20`.\n\n#### Part a {-}\n\nWe again need two pieces of information.\n\n1.  Data on elections in each state, which we already have: `elections_by_state`.\n\n2.  A background map of state boundaries in the US. The boundaries we used for point maps don't work here. (Optional detail: they're `sf` objects and we now need a `data.frame` object.) Instead, we can use the `map_data()` function from the `ggplot2` package:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Get the latitude and longitude coordinates of state boundaries\nstates_map <- map_data(\"state\")\n\n# Check it out\nhead(states_map)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n       long      lat group order  region subregion\n1 -87.46201 30.38968     1     1 alabama      <NA>\n2 -87.48493 30.37249     1     2 alabama      <NA>\n3 -87.52503 30.37249     1     3 alabama      <NA>\n4 -87.53076 30.33239     1     4 alabama      <NA>\n5 -87.57087 30.32665     1     5 alabama      <NA>\n6 -87.58806 30.32665     1     6 alabama      <NA>\n```\n\n\n:::\n:::\n\n\n##### Pause {-}\n\n**Important detail:** Note that the `region` variable in `states_map`, and the `state_name` variable in `elections_by_state` both label states by the full name in lower case letters. This is critical to the background map and our data being able to communicate.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(states_map)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n       long      lat group order  region subregion\n1 -87.46201 30.38968     1     1 alabama      <NA>\n2 -87.48493 30.37249     1     2 alabama      <NA>\n3 -87.52503 30.37249     1     3 alabama      <NA>\n4 -87.53076 30.33239     1     4 alabama      <NA>\n5 -87.57087 30.32665     1     5 alabama      <NA>\n6 -87.58806 30.32665     1     6 alabama      <NA>\n```\n\n\n:::\n\n```{.r .cell-code}\nhead(elections_by_state) \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   state_name state_abbr repub_pct_20 repub_20_categories\n1     alabama         AL        62.03               60-64\n2    arkansas         AR        62.40               60-64\n3     arizona         AZ        49.06               45-49\n4  california         CA        34.33               30-34\n5    colorado         CO        41.90               40-44\n6 connecticut         CT        39.21               35-39\n```\n\n\n:::\n:::\n\n\n##### Part b {-}\n\nNow map `repub_pct_20` by state.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Note where the dataset, elections_by_state, is used\n# Note where the background map, states_map, is used\nggplot(elections_by_state, aes(map_id = state_name, fill = repub_pct_20)) +\n  geom_map(map = states_map) +\n  expand_limits(x = states_map$long, y = states_map$lat) +\n  theme_map() \n```\n\n::: {.cell-output-display}\n![](activity-06_files/figure-html/unnamed-chunk-33-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Make it nicer!\nggplot(elections_by_state, aes(map_id = state_name, fill = repub_pct_20)) +\n  geom_map(map = states_map) +\n  expand_limits(x = states_map$long, y = states_map$lat) +\n  theme_map() + \n  scale_fill_gradientn(name = \"% Republican\", colors = c(\"blue\", \"purple\", \"red\"), values = scales::rescale(seq(0, 100, by = 5)))\n```\n\n::: {.cell-output-display}\n![](activity-06_files/figure-html/unnamed-chunk-34-1.png){width=672}\n:::\n:::\n\n\nIt's not easy to get fine control over the color scale for the quantitative `repub_pct_20` variable. Instead, let's plot the *discretized* version, `repub_20_categories`:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(elections_by_state, aes(map_id = state_name, fill = repub_20_categories)) +\n  geom_map(map = states_map) +\n  expand_limits(x = states_map$long, y = states_map$lat) +\n  theme_map()\n```\n\n::: {.cell-output-display}\n![](activity-06_files/figure-html/unnamed-chunk-35-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load package needed for refining color palette\nlibrary(RColorBrewer)\n\n# Now fix the colors\nggplot(elections_by_state, aes(map_id = state_name, fill = repub_20_categories)) +\n  geom_map(map = states_map) +\n  expand_limits(x = states_map$long, y = states_map$lat) +\n  theme_map() + \n  scale_fill_manual(values = rev(brewer.pal(8, \"RdBu\")), name = \"% Republican\")\n```\n\n::: {.cell-output-display}\n![](activity-06_files/figure-html/unnamed-chunk-36-1.png){width=672}\n:::\n:::\n\n\n##### Part c {-}\n\nWe can add other layers, like points, on top of a choropleth map. Add a Starbucks layer! Do you notice any relationship between Starbucks and elections? Or are we just doing things at this point? ;)\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Get only the starbucks data from the US\nstarbucks_us <- starbucks %>% \n  filter(Country == \"US\")\n\n# Map it\nggplot(elections_by_state, aes(map_id = state_name, fill = repub_20_categories)) +\n  geom_map(map = states_map) +\n  geom_point(\n    data = starbucks_us,\n    aes(x = Longitude, y = Latitude),\n    size = 0.05,\n    alpha = 0.2,\n    inherit.aes = FALSE\n  ) +\n  expand_limits(x = states_map$long, y = states_map$lat) +\n  theme_map() + \n  scale_fill_manual(values = rev(brewer.pal(8, \"RdBu\")), name = \"% Republican\")\n```\n\n::: {.cell-output-display}\n![](activity-06_files/figure-html/unnamed-chunk-37-1.png){width=672}\n:::\n:::\n\n\n**Details (if you're curious)**\n\n-   `map_id` is a required aesthetic for `geom_map()`.\n    -   It specifies which variable in our dataset indicates the region (here `state_name`).\n    -   It connects this variable (`state_name`) to the `region` variable in our mapping background (`states_map`). These variables must have the same possible outcomes in order to be matched up (`alabama`, `alaska`, `arizona`,...).\n-   `expand_limits()` assures that the map covers the entire area it's supposed to, by pulling longitudes and latitudes from the `states_map`.\n\n##### Part d {-}\n\nWe used `geom_sf()` for point maps. What `geom` do we use for choropleth maps?\n\n\n### Exercise 9: County-level choropleth maps {-}\n\nLet's map the 2020 Republican support in each *county*.\n\n##### Part a {-}\n\nWe again need two pieces of information.\n\n1.  Data on elections in each county, which we already have: `elections_by_county`.\n\n2.  A background map of county boundaries in the US, stored in the `county_map` dataset in the `socviz` package:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Get the latitude and longitude coordinates of county boundaries\nlibrary(socviz)\ndata(county_map) \n\n# Check it out\nhead(county_map)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n     long      lat order  hole piece            group    id\n1 1225889 -1275020     1 FALSE     1 0500000US01001.1 01001\n2 1235324 -1274008     2 FALSE     1 0500000US01001.1 01001\n3 1244873 -1272331     3 FALSE     1 0500000US01001.1 01001\n4 1244129 -1267515     4 FALSE     1 0500000US01001.1 01001\n5 1272010 -1262889     5 FALSE     1 0500000US01001.1 01001\n6 1276797 -1295514     6 FALSE     1 0500000US01001.1 01001\n```\n\n\n:::\n:::\n\n\n##### Pause {-}\n\n**Important detail:** We officially have a headache. Our `county_map` refers to each county by a **5-number** `id`. Our `elections_by_counties` data refers to each county by a `county_fips` code, which is *mostly* the same as `id`, BUT drops any 0's at the beginning of the code.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(county_map)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n     long      lat order  hole piece            group    id\n1 1225889 -1275020     1 FALSE     1 0500000US01001.1 01001\n2 1235324 -1274008     2 FALSE     1 0500000US01001.1 01001\n3 1244873 -1272331     3 FALSE     1 0500000US01001.1 01001\n4 1244129 -1267515     4 FALSE     1 0500000US01001.1 01001\n5 1272010 -1262889     5 FALSE     1 0500000US01001.1 01001\n6 1276797 -1295514     6 FALSE     1 0500000US01001.1 01001\n```\n\n\n:::\n\n```{.r .cell-code}\nhead(elections_by_counties)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  state_name state_abbr    county_name county_fips repub_pct_20 median_age\n1    Alabama         AL Autauga County        1001        71.44       37.5\n2    Alabama         AL Baldwin County        1003        76.17       41.5\n3    Alabama         AL Barbour County        1005        53.45       38.3\n4    Alabama         AL    Bibb County        1007        78.43       39.4\n5    Alabama         AL  Blount County        1009        89.57       39.6\n6    Alabama         AL Bullock County        1011        24.84       39.6\n  median_rent repub_20_categories\n1         668               70-79\n2         693               70-79\n3         382               50-59\n4         351               70-79\n5         403               80-89\n6         276               20-29\n```\n\n\n:::\n:::\n\n\nThis just means that we have to wrangle the data so that it can communicate with the background map.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Add 0's at the beginning of any fips_code that's fewer than 5 numbers long\n# Don't worry about the syntax\nelections_by_counties <- elections_by_counties %>% \n  mutate(county_fips = as.character(county_fips)) %>% \n  mutate(county_fips = \n           ifelse(nchar(county_fips) == 4, paste0(\"0\", county_fips), county_fips))\n```\n:::\n\n\n##### Part b {-}\n\n*Now* map Republican support by county. Let's go straight to the discretized `repub_20_categories` variable, and a good color scale.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(elections_by_counties, aes(map_id = county_fips, fill = repub_20_categories)) +\n  geom_map(map = county_map) +\n  scale_fill_manual(values = rev(brewer.pal(10, \"RdBu\")), name = \"% Republican\") +\n  expand_limits(x = county_map$long, y = county_map$lat) +\n  theme_map() +\n  theme(legend.position = \"right\") + \n  coord_equal()\n```\n\n::: {.cell-output-display}\n![](activity-06_files/figure-html/unnamed-chunk-41-1.png){width=672}\n:::\n:::\n\n\n\n\n#### Exercise 10: Play around! {-}\n\nConstruct county-level maps of `median_rent` and `median_age`.\n\n\n#### Exercise 11: Choropleth maps with leaflet {-}\n\nThough `ggplot()` is often better for this purpose, we can also make choropleth maps with `leaflet()`. If you're curious, check out the `leaflet` documentation:\n\n<https://rstudio.github.io/leaflet/choropleths.html>\n\n\n\n## Solutions\n\n<details>\n\n<summary>Click for Solutions</summary>\n\n### Example 1 {-}\n\nBoth addresses used between 0 and 450 therms per month. There seem to be two types of months -- those with lower use around 50 therms and those with higher use around 300/400 therms.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(energy, aes(x = therms, fill = address)) + \n  geom_density(alpha = 0.5)\n```\n\n::: {.cell-output-display}\n![](activity-06_files/figure-html/unnamed-chunk-42-1.png){width=672}\n:::\n:::\n\n\n### Example 2 {-}\n\nEnergy use is seasonal, with higher usage in winter months. It seems that address a uses slightly more energy.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(energy, aes(y = therms, x = date, color = address)) + \n  geom_point()\n```\n\n::: {.cell-output-display}\n![](activity-06_files/figure-html/unnamed-chunk-43-1.png){width=672}\n:::\n\n```{.r .cell-code}\nggplot(energy, aes(y = therms, x = date, color = address)) + \n  geom_line()\n```\n\n::: {.cell-output-display}\n![](activity-06_files/figure-html/unnamed-chunk-43-2.png){width=672}\n:::\n:::\n\n\n### Example 3 {-}\n\nAt both addresses, typical energy use *increased* after renovations.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(energy, aes(y = therms, x = renovated)) + \n  geom_boxplot() + \n  facet_wrap(~ address)\n```\n\n::: {.cell-output-display}\n![](activity-06_files/figure-html/unnamed-chunk-44-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# A density plot isn't very helpful for comparing typical therms in this example!\nggplot(energy, aes(x = therms, fill = renovated)) + \n  geom_density(alpha = 0.5) + \n  facet_wrap(~ address)\n```\n\n::: {.cell-output-display}\n![](activity-06_files/figure-html/unnamed-chunk-44-2.png){width=672}\n:::\n:::\n\n\n### Example 4 {-}\n\nlurking variable = outdoor temperature (as reflected by hdd)\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# It happened to be colder outside after renovations (higher hdd)\nggplot(energy, aes(y = hdd, x = renovated)) + \n  geom_boxplot() + \n  facet_wrap(~ address)\n```\n\n::: {.cell-output-display}\n![](activity-06_files/figure-html/unnamed-chunk-45-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# When controlling for outside temps (via hdd), energy use decreased post-renovation\nggplot(energy, aes(y = therms, x = hdd, color = renovated)) + \n  geom_point(alpha = 0.5) + \n  geom_smooth(method = \"lm\", se = FALSE) + \n  facet_wrap(~ address)\n```\n\n::: {.cell-output-display}\n![](activity-06_files/figure-html/unnamed-chunk-45-2.png){width=672}\n:::\n:::\n\n\n### Example 5 {-}\n\nBUT this was explained by a *confounding* or *omitted* or *lurking* variable: `hdd` (outdoor temperature)\n\n-   After renovation...\n-   *it happened to be colder*...\n-   which then leads to higher energy use.\n\nThus, *when controlling for* outdoor temps, renovations led to *decreased* energy use.\n\n\n### Exercise 3: Your turn {-}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nleaflet(data = starbucks_mn) %>% \n  addTiles() %>% \n  addMarkers()\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"leaflet html-widget html-fill-item\" id=\"htmlwidget-18578b0bc2279de89e5d\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-18578b0bc2279de89e5d\">{\"x\":{\"options\":{\"crs\":{\"crsClass\":\"L.CRS.EPSG3857\",\"code\":null,\"proj4def\":null,\"projectedBounds\":null,\"options\":{}}},\"calls\":[{\"method\":\"addTiles\",\"args\":[\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\",null,null,{\"minZoom\":0,\"maxZoom\":18,\"tileSize\":256,\"subdomains\":\"abc\",\"errorTileUrl\":\"\",\"tms\":false,\"noWrap\":false,\"zoomOffset\":0,\"zoomReverse\":false,\"opacity\":1,\"zIndex\":1,\"detectRetina\":false,\"attribution\":\"&copy; <a href=\\\"https://openstreetmap.org/copyright/\\\">OpenStreetMap<\\/a>,  <a href=\\\"https://opendatacommons.org/licenses/odbl/\\\">ODbL<\\/a>\"}]},{\"method\":\"addMarkers\",\"args\":[[45.85,45.22,45.21,44.73,44.72,45.06,46.37,46.37,47.49,45.17,45.17,44.86,44.83,44.86,44.85,44.86,44.85,44.86,45.06,45.09,45.14,45.13,45.12,45.17,44.75,44.74,44.75,45.57,45.16,45.17,44.86,44.86,44.83,45.2,45.15,45.13,44.83,44.82,45.05,46.81,46.8,46.82,46.81,46.78,44.79,44.83,44.84,44.8,44.81,44.84,44.85,44.89,44.85,44.86,44.88,44.91,44.88,44.91,44.88,44.86,44.91,44.88,44.87,45.32,44.9,45.27,45.28,45.06,44.98,47.21,44.74,44.93,44.87,44.82,44.72,44.71,44.69,44.68,45.18,44.17,44.17,45.13,45.13,45.1,45.09,45.05,44.97,45.05,44.96,44.95,44.98,44.97,44.97,44.96,44.97,44.98,44.96,44.97,44.97,45.07,44.98,44.98,44.98,44.91,45,44.97,44.98,44.97,44.97,44.92,45.29,46.85,46.86,45.03,45.03,44.43,45.03,44.96,44.96,45.28,44.08,44.09,45.02,45.03,45.01,44.57,44.88,44.86,44.02,44.07,44.06,44,43.95,44.02,44.06,45.2,45.2,44.73,45.01,45.01,45.01,45.01,44.89,44.94,44.75,44.74,44.78,45.06,45.08,45.57,44.94,44.88,44.88,44.88,45.55,44.95,44.93,44.94,44.95,44.92,44.95,44.95,45,44.97,44.95,45.04,45.03,45.05,45.08,47.51,44.85,45.55,44.97,44.9,45.04,45.07,44.03,44.94,44.93,44.94,44.94,44.92,44.93,44.89],[-95.39,-93.31999999999999,-93.36,-93.20999999999999,-93.18000000000001,-93.15000000000001,-94.23999999999999,-94.25,-94.91,-93.23,-93.23999999999999,-93.23999999999999,-93.29000000000001,-93.23999999999999,-93.23999999999999,-93.31,-93.23999999999999,-93.31,-93.31999999999999,-93.38,-93.37,-93.36,-93.36,-93.86,-93.29000000000001,-93.29000000000001,-93.3,-93.20999999999999,-93.39,-93.39,-93.52,-93.54000000000001,-93.59999999999999,-93.34999999999999,-93.28,-93.27,-92.95999999999999,-92.93000000000001,-93.36,-92.17,-92.16,-92.08,-92.16,-92.09999999999999,-93.20999999999999,-93.17,-93.17,-93.19,-93.20999999999999,-93.40000000000001,-93.43000000000001,-93.42,-93.43000000000001,-93.44,-93.33,-93.36,-93.31999999999999,-93.33,-93.33,-93.34999999999999,-93.34999999999999,-93.31999999999999,-93.33,-93.56,-93.56999999999999,-93,-93.01000000000001,-93.25,-93.38,-93.53,-92.89,-93.42,-94.38,-93.08,-93.18000000000001,-93.28,-93.28,-93.29000000000001,-93.11,-93.95,-93.95,-93.48999999999999,-93.48,-93.45,-93.44,-93.53,-93.27,-93.36,-93.23999999999999,-93.23999999999999,-93.23999999999999,-93.23,-93.27,-93.29000000000001,-93.23999999999999,-93.27,-93.28,-93.23,-93.25,-93.25,-93.27,-93.27,-93.28,-93.29000000000001,-93.23,-93.28,-93.27,-93.45,-93.44,-93.5,-93.77,-96.77,-96.75,-93.39,-93.02,-93.19,-92.84999999999999,-92.95999999999999,-92.95999999999999,-93.56,-93.23999999999999,-93.25,-93.48,-93.45,-93.45,-92.58,-93.25,-93.29000000000001,-92.45999999999999,-92.53,-92.5,-92.48,-92.47,-92.47,-92.47,-93.55,-93.55,-93.13,-93.16,-93.18000000000001,-93.17,-93.18000000000001,-93.08,-93.15000000000001,-93.38,-93.38,-93.41,-93.14,-93.12,-94.15000000000001,-93.39,-93.20999999999999,-93.20999999999999,-93.20999999999999,-94.19,-93.33,-93.34,-93.14,-93.03,-93.19,-93.17,-93.09999999999999,-92.95,-93.17,-93.16,-92.84,-92.84,-93.06,-93.06,-92.55,-93.77,-94.22,-93.51000000000001,-93.08,-93.02,-93.02,-91.62,-92.94,-92.95999999999999,-92.91,-92.90000000000001,-92.93000000000001,-92.95999999999999,-92.94],null,null,null,{\"interactive\":true,\"draggable\":false,\"keyboard\":true,\"title\":\"\",\"alt\":\"\",\"zIndexOffset\":0,\"opacity\":1,\"riseOnHover\":false,\"riseOffset\":250},null,null,null,null,null,{\"interactive\":false,\"permanent\":false,\"direction\":\"auto\",\"opacity\":1,\"offset\":[0,0],\"textsize\":\"10px\",\"textOnly\":false,\"className\":\"\",\"sticky\":true},null]}],\"limits\":{\"lat\":[43.95,47.51],\"lng\":[-96.77,-91.62]}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n\n### Exercise 3: A simple scatterplot {-}\n\nIt would be nice to also have some actual reference maps of countries in the background.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(starbucks, aes(y = Latitude, x = Longitude)) + \n  geom_point(size = 0.5)\n```\n\n::: {.cell-output-display}\n![](activity-06_files/figure-html/unnamed-chunk-47-1.png){width=672}\n:::\n:::\n\n\n\n### Exercise 6: A state and county-level map {-}\n\n#### Part b {-}\n\nAdjust the code below to make the plot! Remove the `#` to run it.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(midwest_boundaries) +\n  geom_sf() +\n  geom_point(\n    data = starbucks_midwest,\n    aes(x = Longitude, y = Latitude),\n    alpha = 0.7,\n    size = 0.2,\n    color = 'darkgreen'\n  ) +\n  theme_map()\n```\n\n::: {.cell-output-display}\n![](activity-06_files/figure-html/unnamed-chunk-48-1.png){width=672}\n:::\n:::\n\n\n\n### Exercise 7: Contour maps {-}\n\nEspecially when there are lots of point locations, and those locations start overlapping on a map, it can be tough to visualize areas of higher *density*. Consider the Starbucks locations in Canada, Mexico, and the US that we mapped earlier:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Point map (we made this earlier)\n#ggplot(cma_boundaries) + \n # geom_sf() + \n  #geom_point(\n   # data = starbucks_cma,\n    #aes(x = Longitude, y = Latitude),\n    #alpha = 0.3,\n#    size = 0.2,\n #   color = \"darkgreen\"\n  #) +\n  #coord_sf(xlim = c(-179.14, -50), ylim = c(14.54, 83.11)) +\n  #theme_map()\n```\n:::\n\n\nNow check out the contour map.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# What changed in the plot?\n# What changed in our code?!\n#ggplot(cma_boundaries) + \n # geom_sf() + \n#  geom_density_2d(\n  #  data = starbucks_cma,\n#    aes(x = Longitude, y = Latitude),\n #   size = 0.2,\n  #  color = \"darkgreen\"\n # ) +\n # coord_sf(xlim = c(-179.14, -50), ylim = c(14.54, 83.11)) +\n # theme_map()\n```\n:::\n\n\n\n### Exercises Part 3: Choropleth maps {-}\n\nSpatial data isn't always in the form of point locations! For example, recall the state and county-level data on presidential elections.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nelections_by_state <-  read.csv(\"https://mac-stat.github.io/data/election_2020_by_state.csv\")\nelections_by_counties <- read.csv(\"https://mac-stat.github.io/data/election_2020_county.csv\")\n```\n:::\n\n\nIn these datasets, we're interested in the overall election outcome by region (state or county), not the specific geographic location of some observation. Let's wrangle our data first.\n\nWe'll focus on just a few variables of interest, and create a new variable (`repub_20_categories`) that *discretizes* the `repub_pct_20` variable into increments of 5 percentage points (for states) or 10 percentage points (for counties):\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Don't worry about the code!\n\nelections_by_state <- elections_by_state %>% \n  filter(state_abbr != \"DC\") %>% \n  select(state_name, state_abbr, repub_pct_20) %>% \n  mutate(repub_20_categories = \n           cut(repub_pct_20, \n               breaks = seq(30, 70, by = 5), \n               labels = c(\"30-34\", \"35-39\", \"40-44\", \"45-49\",\n                          \"50-54\", \"55-59\", \"60-64\", \"65-70\"), \n               include.lowest = TRUE))\n\nelections_by_counties <- elections_by_counties %>% \n  select(state_name, state_abbr, county_name, county_fips,\n          repub_pct_20, median_age, median_rent) %>% \n  mutate(repub_20_categories = \n           cut(repub_pct_20, \n               breaks = seq(0, 100, by = 10),\n               labels = c(\"0-9\", \"10-19\", \"20-29\", \"30-39\", \"40-49\",\n                          \"50-59\", \"60-69\", \"70-79\", \"80-89\", \"90-100\"),\n               include.lowest = TRUE))\n\n# Add 0's at the beginning of any fips_code that's fewer than 5 numbers long\n# Don't worry about the syntax\nelections_by_counties <- elections_by_counties %>% \n  mutate(county_fips = as.character(county_fips)) %>% \n  mutate(county_fips = \n           ifelse(nchar(county_fips) == 4, paste0(\"0\", county_fips), county_fips))\n```\n:::\n\n\n\n### Exercise 8: State-level choropleth maps {-}\n\n#### Part d {-}\n\n`geom_map()`\n\n\n### Exercise 10: Play around! {-}\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(elections_by_counties, aes(map_id = county_fips, fill = median_rent)) +\n  geom_map(map = county_map) +\n  expand_limits(x = county_map$long, y = county_map$lat) +\n  theme_map() +\n  theme(legend.position = \"right\") + \n  coord_equal() + \n  scale_fill_gradientn(name = \"median rent\", colors = c(\"white\", \"lightgreen\", \"darkgreen\"))\n```\n\n::: {.cell-output-display}\n![](activity-06_files/figure-html/unnamed-chunk-53-1.png){width=672}\n:::\n\n```{.r .cell-code}\nggplot(elections_by_counties, aes(map_id = county_fips, fill = median_age)) +\n  geom_map(map = county_map) +\n  expand_limits(x = county_map$long, y = county_map$lat) +\n  theme_map() +\n  theme(legend.position = \"right\") + \n  coord_equal() + \n  scale_fill_gradientn(name = \"median age\", colors = terrain.colors(10))\n```\n\n::: {.cell-output-display}\n![](activity-06_files/figure-html/unnamed-chunk-53-2.png){width=672}\n:::\n:::\n",
    "supporting": [
      "activity-06_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../site_libs/htmltools-fill-0.5.8.1/fill.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/htmlwidgets-1.6.4/htmlwidgets.js\"></script>\n<script src=\"../site_libs/jquery-3.6.0/jquery-3.6.0.min.js\"></script>\n<link href=\"../site_libs/leaflet-1.3.1/leaflet.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/leaflet-1.3.1/leaflet.js\"></script>\n<link href=\"../site_libs/leafletfix-1.0.0/leafletfix.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/proj4-2.6.2/proj4.min.js\"></script>\n<script src=\"../site_libs/Proj4Leaflet-1.0.1/proj4leaflet.js\"></script>\n<link href=\"../site_libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/leaflet-binding-2.2.2/leaflet.js\"></script>\n<script src=\"../site_libs/leaflet-providers-2.0.0/leaflet-providers_2.0.0.js\"></script>\n<script src=\"../site_libs/leaflet-providers-plugin-2.2.2/leaflet-providers-plugin.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}